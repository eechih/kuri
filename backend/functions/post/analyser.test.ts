import { analyse, AnalyzeResult, findOption, findTags } from './analyser'
import { CrawledPost, Post } from './models'

const crawledPost: CrawledPost = {
  userId: 'test',
  postId: '3383280365270968',
  groupId: '1627303077535381',
  groupName: 'CAT',
  message:
    "æœ‰å°ˆæ«ƒä¸­æ–‡æ¨™\n-----2/14 æ™šä¸Š8é»æº–æ™‚æ”¶å–®------\nF12E-4549 ç¾åœ‹å¥‘çˆ¾æ°é‡‘ç›èŠ±æ¤ç‰©ç²¾è¯åŒ–å¦æ°´40ml\næ‰¹ 170 ç•™è¨€å…§å¤§åœ– (ä¸èƒ½å…¬é–‹è²©å”®)\n ğŸ“ç‰¹åƒ¹ï¼š199\n\nå°ˆæ«ƒå”¯ä¸€å®‰ç“¶ç´šğŸ‘ä¿®è­·èˆ’ç·©åŒ–å¦æ°´æ¨è–¦\nå¥½è©•ä¸æ–·çš„ã€Œé‡‘ç›èŠ±æ¤ç‰©ç²¾è¯åŒ–å¦æ°´ã€\nKIEHL'Sç†±éŠ·60å¹´çš„æ˜æ˜ŸåŒ–å¦æ°´ ğŸŠç†±éŠ·NO.1\næ·±å—åäººå’Œæ¶ˆè²»è€…å–œæ„›\nè¢«å–»ç‚ºã€Œç¥å¥‡åŒ–å¦æ°´ğŸ’¥ã€ï¼ï¼ï¼\næº«å’ŒğŸš«ä¸å«é…’ç²¾ æ•æ„Ÿè‚Œä¹Ÿé©ç”¨\næœ‰æ•ˆä¿®è­·é®å®šèª¿ğŸŒ¿è®“è‚Œè†šæ›´è½è©±\né‹ç”¨ğŸ˜ç¨å®¶ç§‘æŠ€èˆ‡æŠ€è¡“\nèƒå–è‡ªé‡‘ç›èŠ±åŠå¤šç¨®å¤©ç„¶æ¤ç‰©ç²¾è¯âœ¨âœ¨\nå°‡é‡‘ç›èŠ±ğŸ’—5å¤§æ´»èƒå®Œç¾å°å­˜æ–¼èŠ±ç“£ä¸­\nå†æ”¾å…¥åŒ–å¦æ°´ä¸­ğŸ’ªğŸ’ª\nğŸ¤©è®“é‡‘ç›èŠ±åŒ–å¦æ°´é®å®šèˆ’ç·©ã€ä¿®è­·èª¿ç†çš„åŠŸæ•ˆæ›´å¿«åˆæœ‰æ•ˆ\nä¸€æ“¦åŒ–å¦æ°´å°±èƒ½ç§’æ¸…çˆ½è£œæ°´ğŸ’§\n15åˆ†é˜èˆ’ç·©æ•æ„Ÿæ³›ç´…ã€ğŸ”¥3å¤©æ”¹å–„ç—˜ç—˜ç²‰åˆº!*æ­é…æŠ—ç—˜ç”¢å“ä½¿ç”¨\næœ‰æ•ˆä¿®è­·èª¿ç†ğŸ‘ã€èˆ’ç·©è‚Œè†š æå®šæƒ±äººè‚Œè†šå•é¡ŒğŸŒ\n\nâ¤ï¸å¥‘çˆ¾æ°åŒ–å¦æ°´ç¶²è·¯è©•åƒ¹æ¥µé«˜\nâ¤ï¸èƒå–è‡ªé‡‘ç›èŠ±åŠå…¶ä»–å¤©ç„¶æ¤ç‰©ç²¾è¯\nâ¤ï¸å¯æ´»åŒ–ã€èª¿ç†è‚Œè†šï¼Œä¸¦å¯ä¿®è­·é’æ˜¥ç—˜ç–¤ç—•ã€æ”¶æ–‚æ¯›å­”\nâ¤ï¸é®éœèˆ’ç·©è‚Œè†šæ³›ç´…æ•æ„Ÿç—‡ç‹€\nâ¤ï¸å¦å‰çµ•ä½³å¥½ç‰©ï¼Œæ•·å®Œæ•´å€‹è‡‰è¶…æ¸…çˆ½\nâ¤ï¸å®Œå…¨ä¸é»è†©ï¼Œä½¿ç”¨èµ·ä¾†æœ‰æ·¡æ·¡çš„é¦™æ°£\nâ¤ï¸è£¡é¢é‚„æœ‰å°èŠ±ç“£æ›´æ˜¯ã€Œç†¬å¤œå¤œè²“å€‘çš„æ•‘æ˜Ÿã€\nå®Œå…¨é ä¸€ç“¶é‡‘ç›èŠ±ä¾†æ‹¯æ•‘æ€èƒ½ä¸æ„›é‡‘ç›èŠ±åŒ–å¦æ°´\nKIEHL'Sç†±éŠ·50å¹´çš„æ˜æ˜ŸåŒ–å¦æ°´ï¼Œæº«å’Œä¸å«é…’ç²¾ï¼Œæ•æ„Ÿè‚Œä¹Ÿé©ç”¨\nåŒ–å¦æ°´ç¬¬ä¸€é¦–é¸è²·é‡‘ç›èŠ±åŒ–å¦æ°´å°±å°å•¦ï½ğŸ˜˜\n\nğŸš¨ä¿å­˜æœŸé™ï¼š2024.01\nğŸŒ¼è¦æ ¼ï¼š40ml\nğŸŒ¼ç”¢åœ°: ç¾åœ‹\nğŸŒ¼ä½¿ç”¨æ–¹æ³•ï¼šä¸€èˆ¬ä½¿ç”¨æ–¹æ³•\nğŸŒ¼ä¿å­˜æ–¹æ³•ï¼šè«‹ç½®æ–¼é™°æ¶¼è™•ï¼Œè«‹å‹¿ç›´æ¥é™½å…‰ç…§å°„ï¼Œä»¥å…è®Šè³ª",
  wwwURL:
    'https://www.facebook.com/groups/1627303077535381/permalink/3383280365270968/',
  photoImages: [
    'https://scontent-atl3-2.xx.fbcdn.net/v/t39.30808-6/329791109_684257103397212_7742338309848377813_n.jpg?stp=dst-jpg_p526x296&_nc_cat=101&ccb=1-7&_nc_sid=5cd70e&_nc_ohc=ug5s7dLK6lgAX-p0ujN&_nc_ht=scontent-atl3-2.xx&oh=00_AfDN33lKcmFtb_RTSf7avoygz42g3fX2ppEU99CM1RWtMA&oe=63E8F08E',
  ],
  creationTime: '2023-02-08T08:02:17+08:00',
  crawledTime: '2023-02-08T14:51:31+08:00',
}

describe('analyzer', () => {
  test('analyze post', () => {
    const analyzedPost: Post = analyse(crawledPost)
    console.log(analyzedPost)
    expect(analyzedPost.productName).toBe('ç¾åœ‹å¥‘çˆ¾æ°é‡‘ç›èŠ±æ¤ç‰©ç²¾è¯åŒ–å¦æ°´40ml')
    expect(analyzedPost.productPrice).toBe(199)
    expect(analyzedPost.productCost).toBe(170)
    expect(analyzedPost.productOption).toBeUndefined()
    expect(analyzedPost.productStatusDate).toBe('2023-02-14T20:00:00+08:00')
  })
})

describe('findOption', () => {
  test('should find an option group', () => {
    const postMessage =
      'F1-11307 ä¸­å¤§ç«¥æœ¨è€³é‚Šè¢–å‘æ¢ä¸Šè¡£\næ‰¹ç™¼åƒ¹ï¼š190\nğŸ“ç‰¹åƒ¹ï¼š225\n\né¡è‰²ï¼»é»‘ï¼Œå’–ï¼½\n--ä¸‹å–®ç¯„ä¾‹: é»‘100+1'
    const article = postMessage.split('\n')
    const result: AnalyzeResult<string[][]> = findOption(article)
    expect(result?.data).toEqual([['é»‘', 'å’–']])
  })
  test('should find multiple option groups', () => {
    const postMessage =
      'F1-11307 ä¸­å¤§ç«¥æœ¨è€³é‚Šè¢–å‘æ¢ä¸Šè¡£\næ‰¹ç™¼åƒ¹ï¼š190\nğŸ“ç‰¹åƒ¹ï¼š225\n\né¡è‰²ï¼»é»‘ï¼Œå’–/90ï¼Œ100ï¼Œ110ï¼Œ120ï¼½\n--ä¸‹å–®ç¯„ä¾‹: é»‘100+1'
    const article = postMessage.split('\n')
    const result: AnalyzeResult<string[][]> = findOption(article)
    expect(result?.data).toEqual([
      ['é»‘', 'å’–'],
      ['90', '100', '110', '120'],
    ])
  })
  test('should not find any option groups', () => {
    const postMessage =
      'F1-11307 ä¸­å¤§ç«¥æœ¨è€³é‚Šè¢–å‘æ¢ä¸Šè¡£\næ‰¹ç™¼åƒ¹ï¼š190\nğŸ“ç‰¹åƒ¹ï¼š225\n\n--ä¸‹å–®ç¯„ä¾‹: +1'
    const article = postMessage.split('\n')
    const result: AnalyzeResult<string[][]> = findOption(article)
    expect(result?.data).toBeUndefined()
  })
})

describe('findTags', () => {
  test('only find specific keywords', () => {
    const postMessages = [
      '---- ç¾è²¨ "ç´…å’–å“©(1),ç¶ å’–å“©(1),ç‘ªèæ›¼å’–å“©(1)" å¯èªè³¼ å”®å®Œé—œåœ˜ ----\n\nF12E-3826 æ³°åœ‹AROY-Då³é£Ÿç¶ å’–å“©é†¬250ml (2-3äººä»½)\n\næ‰¹:60\nğŸ“ç‰¹åƒ¹: 80 \n\næ¬¾å¼:[ç´…å’–å“©,ç¶ å’–å“©,ç‘ªèæ›¼å’–å“©]---ä¸‹å–®ç¯„ä¾‹: ç´…å’–å“©+1\n\næ‡¶äººè¼•é¬†ç…®å’–å“©ç³»åˆ—~~~\nèª°ä¹Ÿä¸€æ¨£å–œæ­¡æ³°å¼ğŸ’¥!!\nåœ¨å®¶ä¹Ÿèƒ½åƒåˆ°é“åœ°æ³°åœ‹å‘³~~~',
      '------é™é‡100çµ„,å¿«é€Ÿåˆ°è²¨-----å”®å®Œé—œåœ˜\nF12E-2957 å¾·æ©å¥ˆæ¼±å£æ°´è²·ä¸€é€ä¸€(ç‰¹åƒ¹æ´»å‹• 1000ml+500ml)\næ‰¹:230(ç•™è¨€å…§å¤§åœ–) \nğŸ“ç‰¹åƒ¹ï¼š268\n\nğŸ’¦å¸¸æ´—æ‰‹  å¤šæ¼±å£   ä¸€èµ·é é˜²ç—…æ¯’å…¥ä¾µ\nğŸŒµå¾·æ©å¥ˆæ¸…æ–°é›™æ•ˆæ¼±å£æ°´\nä¸å«é…’ç²¾é…æ–¹,å…¨æ–°ã€Œ+æœ¨ç³–é†‡ã€é›™é‡é˜²è›€é…æ–¹,æ¯æ—¥æ—©æ™šä½¿ç”¨.èƒ½å¼·åŒ–æ³•ç‘¯è³ª\næœ‰æ•ˆé™ä½è›€ç‰™ç‡30%-50%ã€‚',
      'é‡æ–°é–‹åœ˜\n-----2/27 æ™šä¸Š8é»æº–æ™‚æ”¶å–®------\nF1-10723 ä¸‰æ®µå¼é˜²æ»‘æ©¡ç­‹é•·ç­’è¥ª\n\næ‰¹ç™¼åƒ¹ï¼š60(ç•™è¨€å…§å¤§åœ–)\nğŸ“ç‰¹åƒ¹ï¼š79 \n\né¡è‰²ï¼»é»‘ï¼Œæ·±è—ï¼Œæ·±æ£•ï¼Œå’–å•¡ï¼Œé…’ç´…ï¼Œè†šï¼Œç™½ï¼Œæ·±ç°ï¼½\n------ä¸‹å–®ç¯„ä¾‹ï¼šé»‘+1',
      '----2/27 æ™šä¸Š8é»æº–æ™‚æ”¶å–®-------------\nF1-11327 æ—¥æœ¬å¤šåŠŸèƒ½é£Ÿç‰©ç›¤è¶…å€¼çµ„\n\næ‰¹ç™¼åƒ¹ï¼š75(ç•™è¨€å…§å¤§åœ–)\nğŸ“ç‰¹åƒ¹ï¼š99\n\næ¬¾å¼ï¼»é•·æ–¹3å€‹è£ï¼Œæ­£æ–¹4å€‹è£ï¼½\n---ä¸‹å–®ç¯„ä¾‹: é•·æ–¹3å€‹è£+1\n\nç”Ÿæ´»å¥½å¹«æ‰‹ï¼Œå¤šåŠŸèƒ½å°ç‰©',
    ]
    const expectedTags = [
      ['ç¾è²¨', 'å”®å®Œé—œåœ˜'],
      ['é™é‡', 'å”®å®Œé—œåœ˜'],
      ['é‡æ–°é–‹åœ˜'],
      [],
    ]

    postMessages.forEach((postMessage, index) => {
      const article = postMessage.split('\n')
      const result: AnalyzeResult<string[]> = findTags(article)
      expect(result?.data).toEqual(expectedTags[index])
    })
  })
})
